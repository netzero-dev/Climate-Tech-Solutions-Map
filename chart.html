<!DOCTYPE html>
<html>
<head>
    <title>Climate Tech Solutions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            max-width: 300px;
        }
        .sector-label {
            font-size: 12px;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    <script>
        const MATURITY_COLORS = {
            'Mature Market': '#1a365d',
            'Market Scale': '#2563eb',
            'Early Market': '#60a5fa',
            'Commercial': '#93c5fd',
            'Pilot': '#bfdbfe',
            'Research': '#dbeafe'
        };

        // Create the SVG container
        const margin = {top: 40, right: 200, bottom: 40, left: 200};
        const width = 1200 - margin.left - margin.right;
        const height = 800 - margin.top - margin.bottom;

        const svg = d3.select('#chart')
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);

        // Load and process the data
        async function loadData() {
            try {
                const response = await fetch('https://netzero-dev.github.io/Climate-Tech-Solutions-Map/data.csv');
                const csvText = await response.text();
                
                const results = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true
                });

                // Process the data
                const sectorData = results.data.reduce((acc, row) => {
                    if (!acc[row.Sector]) {
                        acc[row.Sector] = {
                            sector: row.Sector,
                            total: 0,
                            maturityCounts: {},
                            solutions: {}
                        };
                        Object.keys(MATURITY_COLORS).forEach(maturity => {
                            acc[row.Sector].maturityCounts[maturity] = 0;
                            acc[row.Sector].solutions[maturity] = [];
                        });
                    }
                    
                    acc[row.Sector].maturityCounts[row['Market Maturity']]++;
                    acc[row.Sector].solutions[row['Market Maturity']].push(row.Solutions);
                    acc[row.Sector].total++;
                    
                    return acc;
                }, {});

                // Convert to array and calculate percentages
                const data = Object.entries(sectorData).map(([sector, info]) => {
                    const maturityData = Object.entries(info.maturityCounts).map(([maturity, count]) => ({
                        maturity,
                        percentage: (count / info.total) * 100,
                        solutions: info.solutions[maturity]
                    }));

                    return {
                        sector,
                        maturityData
                    };
                });

                return data;
            } catch (error) {
                console.error('Error loading data:', error);
                return [];
            }
        }

        // Create the visualization
        async function createVisualization() {
            const data = await loadData();
            
            if (data.length === 0) {
                console.error('No data loaded');
                return;
            }

            // Create scales
            const y = d3.scaleBand()
                .domain(data.map(d => d.sector))
                .range([0, height])
                .padding(0.1);

            const x = d3.scaleLinear()
                .domain([0, 100])
                .range([0, width]);

            // Add axes
            svg.append('g')
                .call(d3.axisLeft(y));

            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(10).tickFormat(d => d + '%'));

            // Add bars
            data.forEach(d => {
                let xOffset = 0;
                d.maturityData.forEach(m => {
                    const width = x(m.percentage);
                    
                    svg.append('rect')
                        .attr('x', xOffset)
                        .attr('y', y(d.sector))
                        .attr('width', width)
                        .attr('height', y.bandwidth())
                        .attr('fill', MATURITY_COLORS[m.maturity])
                        .on('mouseover', (event) => {
                            tooltip.transition()
                                .duration(200)
                                .style('opacity', .9);
                            tooltip.html(`
                                <strong>${d.sector}</strong><br/>
                                <strong>${m.maturity}</strong>: ${m.percentage.toFixed(1)}%<br/>
                                <small>Solutions: ${m.solutions.join(', ')}</small>
                            `)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 28) + 'px');
                        })
                        .on('mouseout', () => {
                            tooltip.transition()
                                .duration(500)
                                .style('opacity', 0);
                        });
                    
                    xOffset += width;
                });
            });

            // Add legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width + 10}, 0)`);

            Object.entries(MATURITY_COLORS).forEach(([maturity, color], i) => {
                const legendItem = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);

                legendItem.append('rect')
                    .attr('width', 15)
                    .attr('height', 15)
                    .attr('fill', color);

                legendItem.append('text')
                    .attr('x', 20)
                    .attr('y', 12)
                    .text(maturity)
                    .style('font-size', '12px')
                    .style('font-family', 'sans-serif');
            });

            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -10)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('font-family', 'sans-serif')
                .text('Climate Tech Solutions by Sector and Market Maturity');
        }

        createVisualization();
    </script>
</body>
</html>